name: Require Changeset
description: "Fail PRs to main without a changeset (skip for release PRs)"
runs:
  using: composite
  steps:
    - name: Check for changeset in PR
      shell: bash
      run: |
        echo "PR title: ${{ github.event.pull_request.title }}"
        echo "Actor: ${{ github.actor }}"

        # Skip guard for release PRs created by Changesets
        if [[ "${{ github.event.pull_request.title }}" == "Version Packages"* ]] \
           || [[ "${{ github.actor }}" == "github-actions[bot]" ]]; then
          echo "‚ÑπÔ∏è Release PR detected, skipping changeset check."
          exit 0
        fi

        echo "üîÑ Fetching main branch..."
        git fetch origin main
        
        echo "üîç Finding merge base..."
        if ! MB=$(git merge-base origin/main HEAD 2>&1); then
          echo "‚ùå ERROR: Could not find merge base with origin/main"
          echo "Merge base output: $MB"
          echo "Current branch: $(git branch --show-current)"
          echo "Available branches: $(git branch -r)"
          exit 1
        fi
        
        echo "‚úÖ Merge base found: $MB"
        echo ""
        echo "üîç Checking for changesets in this PR..."
        echo "Changed files since merge base:"
        
        if ! CHANGED_FILES=$(git diff --name-only $MB...HEAD 2>&1); then
          echo "‚ùå ERROR: Could not get changed files"
          echo "Git diff output: $CHANGED_FILES"
          exit 1
        fi
        
        echo "$CHANGED_FILES"

        CHANGESET_FILES=$(git diff --name-only $MB...HEAD | grep -E '^\.changeset/.*\.md$' || true)
        
        if [[ -z "$CHANGESET_FILES" ]]; then
          echo ""
          echo "‚ùå ERROR: No changeset found for this PR!"
          echo ""
          echo "üìù This PR modifies code but doesn't include a changeset."
          echo "   Changesets are required to track version bumps and generate changelogs."
          echo ""
          echo "üîß To fix this:"
          echo "   1. Run: pnpm changeset"
          echo "   2. Follow the prompts to describe your changes"
          echo "   3. Commit the generated .changeset/*.md file"
          echo ""
          echo "üí° Learn more: https://github.com/changesets/changesets"
          echo ""
          exit 1
        fi

        echo ""
        echo "‚úÖ Changeset found:"
        echo "$CHANGESET_FILES"