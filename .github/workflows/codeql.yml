name: CodeQL
on:
  workflow_call:  # reusable called by other workflows
    inputs:
      languages:
        required: false
        type: string
        default: 'javascript'
  schedule:
    - cron: '0 6 * * 1'   # weekly scan (runs standalone)

jobs:
  analyze:
    runs-on: ubuntu-latest
    permissions:
      # required permissions only applies when run by itself, if run as workflow_call parent must specify the permissions
      security-events: write
      pull-requests: write

      contents: read
    steps:
      - uses: actions/checkout@v4
      - name: Check if Code Scanning is enabled
        id: check-scan
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              await github.request('GET /repos/{owner}/{repo}/code-scanning/alerts', {
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: 1
              });
              core.notice("‚úÖ Code Scanning is enabled. Proceeding with CodeQL.");
              core.setOutput('enabled', 'true');
            } catch (e) {
              core.warning("‚ö†Ô∏è Code Scanning is not enabled for this repository. Enable it under Settings ‚Üí Security & analysis.");
              core.setOutput('enabled', 'false');
            }

      - name: Exit if Code Scanning disabled
        if: steps.check-scan.outputs.enabled != 'true'
        run: |
          echo "Skipping CodeQL because Code Scanning is not enabled."
          exit 0

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ inputs.languages }}
      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          output: results.sarif

      - name: Post CodeQL summary to PR
        if: ${{ github.event_name == 'pull_request' }}
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: codeql-report
          message: |
            ### üîí CodeQL Security Scan
            - Workflow: [${{ github.workflow }} run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - Full results: [Code scanning alerts](${{ github.server_url }}/${{ github.repository }}/security/code-scanning)